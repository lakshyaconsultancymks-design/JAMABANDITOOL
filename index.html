<!DOCTYPE html>
<html>
<head>
    <title>Extract All Khasra Blocks (Multiple PDFs)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
</head>
<body>
<h2>Extract FIRST COLUMN Numbers From All Blocks (Multiple PDFs)</h2>
<input type="file" id="pdfFile" accept="application/pdf" multiple>
<button id="copyBtn">Copy All</button>
<pre id="output" style="white-space: pre-wrap;"></pre>

<script>
document.getElementById("pdfFile").addEventListener("change", async function (e) {
    const files = e.target.files;
    if (!files.length) return;

    let finalData = [];

    for (let file of files) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;

        let items = [];

        for (let p = 1; p <= pdf.numPages; p++) {
            let page = await pdf.getPage(p);
            let text = await page.getTextContent();

            text.items.forEach(it => {
                items.push({
                    str: it.str.trim(),
                    x: it.transform[4],
                    y: it.transform[5],
                    page: p,
                    order: items.length
                });
            });
        }

        const START = "खसरा संख्या";
        const END   = "कुल खसरे";

        let startIdx = [];
        let endIdx = [];

        items.forEach((it, i) => {
            if (it.str.includes(START)) startIdx.push(i);
            if (it.str.includes(END))   endIdx.push(i);
        });

        if (startIdx.length === 0 || endIdx.length === 0) continue;

        for (let s of startIdx) {
            let e = endIdx.find(x => x > s);
            if (!e) continue;

            let block = items.slice(s + 1, e);
            if (block.length === 0) continue;

            let minX = Math.min(...block.map(i => i.x));
            let firstCol = block.filter(i => Math.abs(i.x - minX) < 6);

            let nums = firstCol
                .map(i => i.str)
                .filter(v => /^[0-9]+(\/[0-9]+)?$/.test(v));

            if (nums.length > 0) {
                finalData.push(...nums);
            }
        }
    }

    document.getElementById("output").textContent = finalData.join(",");
});

// COPY BUTTON FUNCTION
document.getElementById("copyBtn").addEventListener("click", function() {
    const output = document.getElementById("output").textContent;
    if (!output) return;

    navigator.clipboard.writeText(output).then(() => {
        alert("Copied to clipboard!");
    }).catch(err => {
        alert("Failed to copy: " + err);
    });
});
</script>
</body>
</html>
