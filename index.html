<!DOCTYPE html>
<html>
<head>
    <title>Extract All Khasra Blocks (Multiple PDFs)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #d10000, #0047b3);
            padding: 40px;
            text-align: center;
            color: white;
            min-height: 100vh;
        }

        h1 {
            color: #ffffff;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(0,0,0,0.4);
            margin-bottom: 5px;
        }

        h2 {
            color: #ffebeb;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255,255,255,0.15);
            width: 75%;
            margin: auto;
            margin-top: 30px;
            padding: 30px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 25px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.35);
        }

        h3 {
            color: #ffe1e1;
            font-size: 22px;
        }

        button {
            background: linear-gradient(90deg, #d10000, #0047b3);
            color: white;
            border: none;
            padding: 12px 28px;
            margin-top: 15px;
            margin-right: 10px;
            cursor: pointer;
            font-size: 17px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            transition: 0.2s;
        }

        button:hover {
            background: linear-gradient(90deg, #ff0000, #0a63ff);
            transform: scale(1.05);
        }

        input {
            margin-top: 20px;
            font-size: 16px;
        }

        pre {
            display: none; /* Hidden, used only for copying */
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            background: rgba(255,255,255,0.9);
            color: black;
            font-weight: bold;
        }

        table td {
            padding: 5px 12px;
            border: 1px solid #000;
        }
    </style>
</head>
<body>

<h1>LAKSHYA PROJECT MANAGEMENT</h1>
<h2>JAMABANDI TOOL</h2>

<div class="card">
    <h3>GET KHASRA DETAILS</h3>

    <input type="file" id="pdfFile" accept="application/pdf" multiple>
    <br>
    <button id="copyBtn">Copy All</button>
    <button id="clearBtn">Clear</button>

    <pre id="output"></pre> <!-- Hidden for copy -->
    <div id="tableOutput"></div> <!-- Display table here -->
</div>

<script>
document.getElementById("pdfFile").addEventListener("change", async function (e) {
    const files = e.target.files;
    if (!files.length) return;

    let finalData = [];

    for (let file of files) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;

        let items = [];

        for (let p = 1; p <= pdf.numPages; p++) {
            let page = await pdf.getPage(p);
            let text = await page.getTextContent();

            text.items.forEach(it => {
                items.push({
                    str: it.str.trim(),
                    x: it.transform[4],
                    y: it.transform[5],
                    page: p,
                    order: items.length
                });
            });
        }

        const START = "खसरा संख्या";
        const END   = "कुल खसरे";

        let startIdx = [];
        let endIdx = [];

        items.forEach((it, i) => {
            if (it.str.includes(START)) startIdx.push(i);
            if (it.str.includes(END))   endIdx.push(i);
        });

        if (startIdx.length === 0 || endIdx.length === 0) continue;

        for (let s of startIdx) {
            let e = endIdx.find(x => x > s);
            if (!e) continue;

            let block = items.slice(s + 1, e);
            if (block.length === 0) continue;

            let minX = Math.min(...block.map(i => i.x));
            let firstCol = block.filter(i => Math.abs(i.x - minX) < 3);

            let nums = firstCol
                .map(i => i.str)
                .filter(v => /^[0-9]+(\/[0-9]+)?$/.test(v));

            if (nums.length > 0) {
                finalData.push(...nums);
            }
        }
    }

    // Display as table with 1 number per row
    const tableOutput = document.getElementById("tableOutput");
    if(finalData.length > 0){
        let tableHTML = "<table>";
        finalData.forEach(val => {
            tableHTML += `<tr><td>${val}</td></tr>`;
        });
        tableHTML += "</table>";
        tableOutput.innerHTML = tableHTML;
    } else {
        tableOutput.innerHTML = "<p>No data found!</p>";
    }

    // Store comma-separated for copying
    document.getElementById("output").textContent = finalData.join(",");
});

document.getElementById("copyBtn").addEventListener("click", function() {
    const output = document.getElementById("output").textContent;
    if (!output) return;

    navigator.clipboard.writeText(output).then(() => {
        alert("Copied to clipboard!");
    }).catch(err => {
        alert("Failed to copy: " + err);
    });
});

// Clear button functionality
document.getElementById("clearBtn").addEventListener("click", function() {
    document.getElementById("pdfFile").value = "";  // Reset file input
    document.getElementById("tableOutput").innerHTML = "";  // Remove table
    document.getElementById("output").textContent = "";      // Clear hidden copy
});
</script>

</body>
</html>
